<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>SpySignal Premium ‚Äî Stealth E2EE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root {
            --bg: #02040a;
            --bg-alt: #050814;
            --bg-panel: #080d1c;
            --accent: #3df2ff;
            --accent-soft: rgba(61, 242, 255, 0.2);
            --accent-strong: #00ffc6;
            --danger: #ff4d7a;
            --warn: #ffcc4d;
            --text: #f5f7ff;
            --muted: #8a90a3;
            --border: #151a2c;
            --tag-bg: #0b1120;
            --lock-pro: #f5c542;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF UI Text", "Segoe UI", sans-serif;
            background:
                radial-gradient(circle at 10% 0, rgba(61, 242, 255, 0.2) 0, transparent 55%),
                radial-gradient(circle at 90% 100%, rgba(0, 255, 198, 0.16) 0, transparent 55%),
                #02040a;
            color: var(--text);
        }

        .app-shell {
            max-width: 520px;
            margin: 0 auto;
            min-height: 100vh;
            padding: 10px 10px 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 10px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-orb {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            position: relative;
            background:
                radial-gradient(circle at 30% 20%, #3df2ff 0, #02040a 60%);
            box-shadow:
                0 0 12px rgba(0, 255, 198, 0.35),
                0 0 40px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 255, 198, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-orb span {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: .08em;
        }

        .brand-text h1 {
            margin: 0;
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge-premium {
            font-size: 10px;
            padding: 2px 7px;
            border-radius: 999px;
            border: 1px solid rgba(255, 215, 0, 0.8);
            background: rgba(36, 26, 4, 0.9);
            color: #ffe38a;
            text-transform: uppercase;
            letter-spacing: .08em;
        }

        .brand-text .subtitle {
            font-size: 11px;
            color: var(--muted);
            margin-top: 1px;
        }

        .top-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
        }

        .sec-indicator {
            font-size: 10px;
            padding: 3px 9px;
            border-radius: 999px;
            background: radial-gradient(circle at 20% 0, rgba(61, 242, 255, 0.4) 0, rgba(7, 16, 32, 0.95) 65%);
            border: 1px solid rgba(61, 242, 255, 0.6);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .sec-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: radial-gradient(circle, #00ffc6 0, #089e7e 60%);
            box-shadow: 0 0 12px rgba(0, 255, 198, 0.8);
        }

        .sec-dot.weak {
            background: radial-gradient(circle, #ffb347 0, #ff7a2f 60%);
            box-shadow: 0 0 10px rgba(255, 122, 47, 0.7);
        }

        .sec-dot.off {
            background: radial-gradient(circle, #ff9ba6 0, #ff4057 60%);
            box-shadow: 0 0 10px rgba(255, 64, 87, 0.7);
        }

        .btn-upgrade {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255, 215, 0, 0.6);
            background: rgba(37, 29, 6, 0.96);
            color: #ffeaa7;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .btn-upgrade span.icon {
            font-size: 13px;
        }

        .status-bar {
            margin: 0 4px;
            padding: 6px 9px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            background: rgba(3, 9, 24, 0.95);
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: radial-gradient(circle, #81ffb7 0, #08c96a 60%);
            box-shadow: 0 0 10px rgba(77, 255, 153, 0.8);
        }

        .status-dot.offline {
            background: radial-gradient(circle, #ff9b9b 0, #ff4040 60%);
            box-shadow: 0 0 8px rgba(255, 64, 64, 0.8);
        }

        .status-text-main {
            font-weight: 500;
        }

        .status-text-url {
            color: var(--muted);
        }

        .layout {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card {
            background: radial-gradient(circle at top left, rgba(61, 242, 255, 0.08) 0, rgba(5, 8, 20, 0.98) 45%);
            border-radius: 16px;
            padding: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.75);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .08em;
            opacity: .9;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .badge-e2ee {
            font-size: 10px;
            padding: 3px 7px;
            border-radius: 999px;
            border: 1px solid rgba(61, 242, 255, 0.6);
            background: rgba(4, 12, 24, 0.96);
            color: #9ff9ff;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-e2ee span.lock {
            font-size: 12px;
        }

        .field-label {
            font-size: 11px;
            color: var(--muted);
            margin: 5px 1px 3px;
        }

        .input, .select, .textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #050816;
            color: var(--text);
            font-size: 13px;
            outline: none;
        }

        .textarea {
            min-height: 60px;
            resize: vertical;
        }

        .input:focus, .textarea:focus, .select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(61, 242, 255, 0.6);
        }

        .btn-main {
            width: 100%;
            padding: 9px 12px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 9px;
            background: linear-gradient(135deg, #3df2ff, #00ffc6);
            color: #02040a;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-main:active {
            transform: translateY(1px);
            filter: brightness(.95);
        }

        .btn-ghost {
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(5, 11, 24, 0.96);
            color: var(--text);
            font-size: 12px;
            padding: 5px 9px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .two-columns {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @media (min-width: 720px) {
            .two-columns {
                flex-direction: row;
            }

            .two-columns > .col {
                flex: 1;
            }
        }

        .search-results {
            max-height: 140px;
            overflow-y: auto;
            margin-top: 6px;
        }

        .user-item {
            background: #050a16;
            border-radius: 10px;
            padding: 8px 9px;
            margin-bottom: 5px;
            border: 1px solid rgba(35, 44, 74, 0.9);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
        }

        .user-item:hover {
            border-color: var(--accent);
            background: rgba(7, 16, 32, 0.95);
        }

        .user-main {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 13px;
            font-weight: 500;
        }

        .user-meta {
            font-size: 11px;
            color: var(--muted);
        }

        .user-tag-pro {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.6);
            color: #ffe58a;
        }

        .chat-window {
            border-radius: 13px;
            border: 1px solid var(--border);
            background: radial-gradient(circle at top left, rgba(61, 242, 255, 0.06) 0, #02040a 40%);
            height: 260px;
            padding: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chat-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }

        .chat-peer-title {
            font-size: 13px;
            font-weight: 500;
        }

        .chat-peer-title span {
            color: var(--accent);
        }

        .tiny-muted {
            font-size: 10px;
            color: var(--muted);
        }

        .secret-row {
            margin-top: 6px;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .secret-row .input {
            font-size: 12px;
            padding: 7px 9px;
        }

        .secret-row button {
            white-space: nowrap;
        }

        .secret-helper {
            font-size: 10px;
            color: var(--muted);
            margin-top: 3px;
        }

        .msg {
            padding: 7px 9px;
            border-radius: 11px;
            font-size: 13px;
            max-width: 78%;
            line-height: 1.4;
            background: #091024;
            animation: fadeUp .16s ease-out forwards;
            opacity: 0;
            transform: translateY(3px);
            word-wrap: break-word;
        }

        .msg.me {
            margin-left: auto;
            background: linear-gradient(135deg, #3df2ff, #00ffc6);
            color: #02040a;
        }

        .msg-file {
            font-size: 12px;
            padding: 6px 7px;
            border-radius: 9px;
            background: rgba(5, 9, 20, 0.9);
            margin-top: 4px;
        }

        .msg-meta {
            font-size: 9px;
            margin-top: 2px;
            color: rgba(184, 194, 216, 0.85);
        }

        .msg.me .msg-meta {
            color: rgba(7, 26, 28, 0.85);
        }

        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-input-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
        }

        .chat-input-row .input {
            flex: 1;
        }

        .chat-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .btn-icon {
            width: 38px;
            height: 38px;
            border-radius: 11px;
            border: 1px solid var(--border);
            background: rgba(5, 10, 24, 0.96);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .btn-icon.pro-locked {
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        }

        .btn-send {
            width: 44px;
            height: 38px;
            border-radius: 11px;
            border: none;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .call-status {
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px;
        }

        .file-input {
            display: none;
        }

        .pro-pill {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(255, 215, 0, 0.7);
            background: rgba(32, 24, 6, 0.96);
            color: #ffeaa7;
        }

        .settings-grid {
            display: grid;
            gap: 6px;
            grid-template-columns: minmax(0, 1fr);
        }

        .setting-item {
            padding: 7px 8px;
            border-radius: 10px;
            background: rgba(5, 10, 24, 0.96);
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .setting-main {
            font-size: 11px;
            color: var(--muted);
        }

        .setting-title {
            font-size: 12px;
            color: var(--text);
            margin-bottom: 1px;
        }

        .setting-toggle {
            font-size: 11px;
            padding: 3px 7px;
            border-radius: 999px;
            border: 1px solid var(--border);
            cursor: pointer;
            background: #040816;
        }

        .setting-toggle.pro {
            border-color: rgba(255, 215, 0, 0.6);
            color: #ffeaa7;
        }

        .toast {
            position: fixed;
            bottom: 14px;
            left: 50%;
            transform: translateX(-50%);
            background: #050914;
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 7px 14px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 6px;
            z-index: 999;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }

        .toast.show {
            display: inline-flex;
            animation: fadeToast .2s ease-out;
        }

        .toast-error {
            border-color: rgba(255, 85, 120, 0.7);
            color: #ffb3c4;
        }

        @keyframes fadeToast {
            from {
                opacity: 0;
                transform: translate(-50%, 4px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .pill-small {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(11, 16, 30, 0.95);
            border: 1px solid var(--border);
        }

        .muted {
            color: var(--muted);
        }
    </style>
</head>
<body>
<div class="app-shell">
    <!-- TOP BAR -->
    <div class="topbar">
        <div class="brand">
            <div class="logo-orb">
                <span>SS</span>
            </div>
            <div class="brand-text">
                <h1>SpySignal <span class="badge-premium">Premium</span></h1>
                <div class="subtitle">Stealth messenger for paranoid agents</div>
            </div>
        </div>
        <div class="top-actions">
            <div class="sec-indicator" id="sec-indicator">
                <div class="sec-dot off" id="sec-dot"></div>
                <span id="sec-label">E2EE: –≤–∏–º–∫–Ω–µ–Ω–æ</span>
            </div>
            <button class="btn-upgrade" onclick="fakeUpgrade()">
                <span class="icon">‚≠êÔ∏è</span>
                <span id="upgrade-label">Upgrade to PRO</span>
            </button>
        </div>
    </div>

    <!-- BACKEND STATUS -->
    <div class="status-bar">
        <div class="status-dot offline" id="backend-dot"></div>
        <div>
            <div class="status-text-main" id="backend-label">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–µ–∫–µ–Ω–¥—É‚Ä¶</div>
            <div class="status-text-url" id="backend-url"></div>
        </div>
    </div>

    <!-- LAYOUT -->
    <div class="layout">
        <!-- LOGIN / ID CARD -->
        <div class="card" id="login-card">
            <div class="card-header">
                <div>
                    <div class="card-title">01 ¬∑ –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∞–≥–µ–Ω—Ç–∞</div>
                    <div class="card-subtitle">
                        –í–≤–µ–¥–∏ –ø–æ–∑–∏–≤–Ω–∏–π. –¢–≤—ñ–π ID –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø–æ—à—É–∫—É —Ç–∞ —Ç–∞—Ä–∏—Ñ—ñ–≤. –ù—ñ—è–∫–∏—Ö –ø–∞—Ä–æ–ª—ñ–≤, –ª–∏—à–µ —Ç–æ–∫–µ–Ω.
                    </div>
                </div>
                <div class="badge-e2ee">
                    <span class="lock">üîê</span> keys: local only
                </div>
            </div>

            <div class="field-label">–ü–æ–∑–∏–≤–Ω–∏–π (username)</div>
            <input id="username" class="input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, ShadowFox" autocomplete="off">

            <button class="btn-main" onclick="registerUser()">
                <span>üîì –£–≤—ñ–π—Ç–∏ –≤ SpySignal</span>
            </button>

            <div class="field-label">–°—Ç–∞—Ç—É—Å –∞–∫–∞—É–Ω—Ç—É</div>
            <div id="account-info" class="tiny-muted">
                –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ.
            </div>
        </div>

        <!-- MAIN COLUMNS: CONTACT + CHAT + SETTINGS -->
        <div class="two-columns" id="main-columns" style="display:none;">
            <!-- LEFT: CONTACTS + SETTINGS -->
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">02 ¬∑ –ü–æ—à—É–∫ –∞–≥–µ–Ω—Ç–∞</div>
                        <button class="btn-ghost" onclick="logout()">
                            –í–∏–π—Ç–∏
                        </button>
                    </div>
                    <div class="card-subtitle">
                        –í–≤–µ–¥–∏ ID –∞–±–æ username —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞. –û–±–µ—Ä—ñ—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ–≥–æ –∫–∞–Ω–∞–ª—É.
                    </div>

                    <div class="field-label">–ü–æ—à—É–∫ (ID –∞–±–æ username)</div>
                    <input id="search" class="input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 2 –∞–±–æ NightOwl" oninput="searchUser()">

                    <div class="search-results" id="search-results"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">04 ¬∑ –ü—Ä–µ–º—ñ—É–º & —Ä–µ–∂–∏–º–∏</div>
                        <span class="pill-small muted" id="pro-pill">Free plan</span>
                    </div>
                    <div class="card-subtitle">
                        –î–µ—è–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–æ—Å—Ç—É–ø–Ω—ñ –ª–∏—à–µ —É PRO (Stealth Mode, –≤–µ–ª–∏–∫—ñ —Ñ–∞–π–ª–∏, –∞–Ω–æ–Ω—ñ–º–Ω—ñ –¥–∑–≤—ñ–Ω–∫–∏).
                    </div>

                    <div class="settings-grid">
                        <div class="setting-item">
                            <div class="setting-main">
                                <div class="setting-title">Stealth Mode</div>
                                <div>–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π UI, –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è —á–∞—Ç—É –ø—Ä–∏ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—ñ –µ–∫—Ä–∞–Ω—É.</div>
                            </div>
                            <button class="setting-toggle pro" onclick="needPro()">
                                PRO
                            </button>
                        </div>

                        <div class="setting-item">
                            <div class="setting-main">
                                <div class="setting-title">–°–µ–∫—Ä–µ—Ç–Ω—ñ –≥—Ä—É–ø–∏</div>
                                <div>–ì—Ä—É–ø–æ–≤—ñ —á–∞—Ç–∏ –∑ –ø—Å–µ–≤–¥–æ–Ω—ñ–º–∞–º–∏, —Å–ø–∏—Å–æ–∫ —É—á–∞—Å–Ω–∏–∫—ñ–≤ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π.</div>
                            </div>
                            <button class="setting-toggle pro" onclick="needPro()">
                                PRO
                            </button>
                        </div>

                        <div class="setting-item">
                            <div class="setting-main">
                                <div class="setting-title">–ë–µ–∫–∞–ø –∫–ª—é—á—ñ–≤ —É —Å–µ–π—Ñ</div>
                                <div>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π backup shared secrets —É —Ö–º–∞—Ä—ñ (—Ç—ñ–ª—å–∫–∏ PRO).</div>
                            </div>
                            <button class="setting-toggle pro" onclick="needPro()">
                                PRO
                            </button>
                        </div>

                        <div class="setting-item">
                            <div class="setting-main">
                                <div class="setting-title">–¢–∏–º—á–∞—Å–æ–≤—ñ —á–∞—Ç–∏</div>
                                <div>Self-destruct –ø–æ —Ç–∞–π–º–µ—Ä—É (–º–æ–∂–Ω–∞ –≤–∫–ª—é—á–∏—Ç–∏ —ñ —É Free).</div>
                            </div>
                            <button class="setting-toggle" onclick="toggleSelfDestruct()">
                                Toggle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: CHAT + CALL -->
            <div class="col">
                <div class="card">
                    <div class="chat-header-row">
                        <div>
                            <div class="chat-peer-title" id="chat-peer">
                                03 ¬∑ –ß–∞—Ç <span>(–æ–±–µ—Ä–∏ –∞–≥–µ–Ω—Ç–∞ –∑–ª—ñ–≤–∞)</span>
                            </div>
                            <div class="tiny-muted" id="chat-meta">
                                Shared secret: –Ω–µ –∑–∞–¥–∞–Ω–æ ¬∑ Forward secrecy: –≤–∏–º–∫–Ω–µ–Ω–æ
                            </div>
                        </div>
                        <div class="tiny-muted" id="call-status">
                            –î–∑–≤—ñ–Ω–æ–∫: –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
                        </div>
                    </div>

                    <div class="secret-row">
                        <input id="dialog-secret" class="input" placeholder="–°–ø—ñ–ª—å–Ω–∏–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è –¥—ñ–∞–ª–æ–≥—É (–ø–∞—Ä–æ–ª—å)" autocomplete="off">
                        <button class="btn-ghost" onclick="saveDialogSecret()">
                            üîê –ó–±–µ—Ä–µ–≥—Ç–∏ —Å–µ–∫—Ä–µ—Ç
                        </button>
                    </div>
                    <div class="secret-helper">
                        –í–∏ —Ç–∞ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫ –º–∞—î—Ç–µ –≤–≤–µ—Å—Ç–∏ <b>–æ–¥–Ω–∞–∫–æ–≤–∏–π —Å–µ–∫—Ä–µ—Ç</b>. –ó –Ω—å–æ–≥–æ
                        –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –∫–ª—é—á—ñ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–ª—è —Ç–µ–∫—Å—Ç—É —Ç–∞ —Ñ–∞–π–ª—ñ–≤. –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–Ω–∞—î —Ü–µ–π —Å–µ–∫—Ä–µ—Ç.
                    </div>

                    <div class="chat-window" id="chat-window"></div>

                    <div class="chat-input-row">
                        <input id="msg-input" class="input" placeholder="–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶" oninput="onTyping()">
                        <button class="btn-send" onclick="sendMessage()">
                            ‚û§
                        </button>
                    </div>

                    <div class="chat-actions">
                        <label class="btn-icon" title="–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–∞–π–ª (E2EE)">
                            üìÅ
                            <input id="file-input" type="file" class="file-input" onchange="handleFileChosen(event)">
                        </label>

                        <button class="btn-icon" onclick="startCall()" title="–ü–æ—á–∞—Ç–∏ –¥–∑–≤—ñ–Ω–æ–∫">
                            üìû
                        </button>

                        <button class="btn-icon" onclick="endCall()" title="–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –¥–∑–≤—ñ–Ω–æ–∫">
                            ‚èπ
                        </button>

                        <button class="btn-icon pro-locked" onclick="needPro()" title="–ê–Ω–æ–Ω—ñ–º–Ω–∏–π –¥–∑–≤—ñ–Ω–æ–∫ (PRO)">
                            üïµÔ∏è
                        </button>
                    </div>

                    <div class="call-status" id="typing-indicator"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
</div>

<script>
    // ---------- CONFIG ----------
    const ORIGIN = window.location.origin;
    const API_BASE = ORIGIN + "/api";

    const backendDot = document.getElementById("backend-dot");
    const backendLabel = document.getElementById("backend-label");
    const backendUrlEl = document.getElementById("backend-url");
    const toastEl = document.getElementById("toast");

    backendUrlEl.textContent = ORIGIN.replace("https://", "");

    const secDot = document.getElementById("sec-dot");
    const secLabel = document.getElementById("sec-label");
    const accountInfoEl = document.getElementById("account-info");
    const proPillEl = document.getElementById("pro-pill");
    const upgradeLabel = document.getElementById("upgrade-label");
    const chatMetaEl = document.getElementById("chat-meta");
    const chatPeerEl = document.getElementById("chat-peer");
    const chatWindowEl = document.getElementById("chat-window");
    const typingIndicatorEl = document.getElementById("typing-indicator");
    const callStatusEl = document.getElementById("call-status");

    const encoder = new TextEncoder();
    const decoder = new TextDecoder();

    let myID = null;
    let myUsername = null;
    let authToken = null;
    let isPro = false;
    let proUntil = null;

    let currentPeerID = null;
    let currentPeerUsername = null;

    let selfDestructEnabled = false;

    // For per-dialog forward secrecy: rootKey derived from shared secret,
    // per-message keys = HKDF(rootKey, sender, receiver, index)
    const dialogStates = {}; // dialogId -> {messages: [], timestamps...}

    function dialogIdFor(peerID) {
        if (!myID || !peerID) return null;
        const a = String(myID);
        const b = String(peerID);
        return (a < b) ? (a + "_" + b) : (b + "_" + a);
    }

    // ---------- UI HELPERS ----------

    function showToast(msg, isError = false) {
        toastEl.textContent = msg;
        toastEl.className = "toast show" + (isError ? " toast-error" : "");
        setTimeout(() => {
            toastEl.classList.remove("show");
        }, 2600);
    }

    function setBackendStatus(ok) {
        if (ok) {
            backendDot.classList.remove("offline");
            backendLabel.textContent = "–ë–µ–∫–µ–Ω–¥ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ";
        } else {
            backendDot.classList.add("offline");
            backendLabel.textContent = "–ù–µ–º–∞—î –∑–≤'—è–∑–∫—É –∑ –±–µ–∫–µ–Ω–¥–æ–º";
        }
    }

    function setSecurityLevel(level) {
        // level: "off", "weak", "strong"
        secDot.classList.remove("weak", "off");
        if (level === "strong") {
            secLabel.textContent = "E2EE: MAX (secret + FS)";
        } else if (level === "weak") {
            secDot.classList.add("weak");
            secLabel.textContent = "E2EE: —Ç—ñ–ª—å–∫–∏ TLS / demo";
        } else {
            secDot.classList.add("off");
            secLabel.textContent = "E2EE: –≤–∏–º–∫–Ω–µ–Ω–æ";
        }
    }

    function updateSecurityIndicator() {
        if (!currentPeerID) {
            setSecurityLevel("off");
            chatMetaEl.textContent = "Shared secret: –Ω–µ –∑–∞–¥–∞–Ω–æ ¬∑ Forward secrecy: –≤–∏–º–∫–Ω–µ–Ω–æ";
            return;
        }
        const dId = dialogIdFor(currentPeerID);
        const secret = localStorage.getItem("spysignal_secret_" + dId);
        if (secret && secret.length >= 6) {
            setSecurityLevel("strong");
            chatMetaEl.textContent = "Shared secret: –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ¬∑ Forward secrecy: –∞–∫—Ç–∏–≤–Ω–∞ (per-message keys)";
        } else {
            setSecurityLevel("weak");
            chatMetaEl.textContent = "Shared secret: –Ω–µ–º–∞—î ¬∑ –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ HTTPS";
        }
    }

    // ---------- CRYPTO (HKDF + AES-GCM) ----------

    async function hkdf(ikmBytes, infoStr) {
        const ikmKey = await crypto.subtle.importKey(
            "raw",
            ikmBytes,
            "HKDF",
            false,
            ["deriveBits"]
        );

        const info = encoder.encode(infoStr);
        const salt = new Uint8Array(32); // all zeros, deterministic

        const bits = await crypto.subtle.deriveBits(
            {
                name: "HKDF",
                hash: "SHA-256",
                salt,
                info
            },
            ikmKey,
            256
        );
        return new Uint8Array(bits);
    }

    async function deriveRootKeyForDialog(peerID) {
        const dId = dialogIdFor(peerID);
        const secret = localStorage.getItem("spysignal_secret_" + dId);
        if (!secret || secret.length < 6) {
            throw new Error("–°–ø—ñ–ª—å–Ω–∏–π —Å–µ–∫—Ä–µ—Ç –Ω–µ –∑–∞–¥–∞–Ω–æ –∞–±–æ –Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π");
        }
        const ikmBytes = encoder.encode(secret);
        const root = await hkdf(ikmBytes, "SpySignalRoot|" + dId);
        return root; // Uint8Array(32)
    }

    async function deriveMsgKey(rootKeyBytes, senderID, receiverID, index) {
        const info = `SpySignalMsg|${senderID}|${receiverID}|${index}`;
        const keyBytes = await hkdf(rootKeyBytes, info);
        const key = await crypto.subtle.importKey(
            "raw",
            keyBytes,
            { name: "AES-GCM" },
            false,
            ["encrypt", "decrypt"]
        );
        return key;
    }

    function bufToBase64(buf) {
        let bin = "";
        const bytes = new Uint8Array(buf);
        for (let b of bytes) bin += String.fromCharCode(b);
        return btoa(bin);
    }

    function base64ToBuf(b64) {
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
        return bytes.buffer;
    }

    async function encryptPayload(peerID, payloadObj, msgsSoFarFromMe) {
        const rootKey = await deriveRootKeyForDialog(peerID);
        const senderID = myID;
        const receiverID = peerID;
        const index = msgsSoFarFromMe; // number of previous messages –≤—ñ–¥ –º–µ–Ω–µ –¥–æ –Ω—å–æ–≥–æ

        const aesKey = await deriveMsgKey(rootKey, senderID, receiverID, index);
        const iv = crypto.getRandomValues(new Uint8Array(12));

        const plaintext = encoder.encode(JSON.stringify(payloadObj));
        const ciphertextBuf = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv },
            aesKey,
            plaintext
        );

        return {
            iv: bufToBase64(iv.buffer),
            ciphertext: bufToBase64(ciphertextBuf)
        };
    }

    async function decryptPayload(peerID, msgRecord, outgoingCountSeen, incomingCountSeen) {
        const rootKey = await deriveRootKeyForDialog(peerID);

        const fromMe = (msgRecord.from_id === myID);
        const senderID = msgRecord.from_id;
        const receiverID = fromMe ? peerID : myID;
        const index = fromMe ? outgoingCountSeen : incomingCountSeen;

        const aesKey = await deriveMsgKey(rootKey, senderID, receiverID, index);

        const ivBuf = base64ToBuf(msgRecord.iv);
        const ctBuf = base64ToBuf(msgRecord.ciphertext);

        let plaintext;
        try {
            const plainBuf = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv: new Uint8Array(ivBuf) },
                aesKey,
                ctBuf
            );
            plaintext = decoder.decode(plainBuf);
        } catch (e) {
            console.warn("–ü–æ–º–∏–ª–∫–∞ –¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è", e);
            return null;
        }

        try {
            return JSON.parse(plaintext);
        } catch {
            return { kind: "text", body: plaintext };
        }
    }

    // ---------- BACKEND CHECK ----------

    async function checkBackend() {
        try {
            const res = await fetch(ORIGIN + "/health");
            if (!res.ok) throw new Error("bad");
            const data = await res.json();
            if (data.status === "ok") {
                setBackendStatus(true);
            } else {
                setBackendStatus(false);
            }
        } catch {
            setBackendStatus(false);
        }
    }
    checkBackend();
    setInterval(checkBackend, 10000);

    // ---------- AUTH / ACCOUNT ----------

    async function registerUser() {
        const username = document.getElementById("username").value.trim();
        if (!username) {
            showToast("–í–≤–µ–¥–∏ –ø–æ–∑–∏–≤–Ω–∏–π", true);
            return;
        }

        try {
            // —Å–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–±—É—î–º–æ /api/users/register
            let url = API_BASE + "/users/register";
            let res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username })
            });

            if (res.status === 404) {
                // fallback –Ω–∞ /api/register (—è–∫—â–æ —Ç–∞–∫–∏–π –º–∞—Ä—à—Ä—É—Ç)
                url = API_BASE + "/register";
                res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username })
                });
            }

            const data = await res.json();
            if (!res.ok || !data.id) {
                console.error("register error", data);
                showToast("–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó", true);
                return;
            }

            myID = data.id;
            myUsername = data.username;
            authToken = data.token || null;

            document.getElementById("login-card").style.display = "none";
            document.getElementById("main-columns").style.display = "flex";

            accountInfoEl.textContent = `ID: ${myID}, username: ${myUsername}`;
                        showToast("–£—Å–ø—ñ—à–Ω–æ. –¢–≤—ñ–π –ø–æ–∑–∏–≤–Ω–∏–π –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ");

            // —Å—Ç–∞—Ç—É—Å PRO
            checkAccountStatus();

        } catch (e) {
            console.error(e);
            showToast("–ü–æ–º–∏–ª–∫–∞ –∑–≤‚Äô—è–∑–∫—É –∑ —Å–µ—Ä–≤–µ—Ä–æ–º", true);
        }
    }


    async function checkAccountStatus() {
        try {
            const res = await fetch(API_BASE + `/users/status?user_id=${myID}`);
            const data = await res.json();

            if (data.error) {
                isPro = false;
                proUntil = null;
            } else {
                isPro = data.is_pro;
                proUntil = data.pro_until;
            }

            if (isPro) {
                proPillEl.textContent = "PRO";
                proPillEl.style.background = "rgba(255,215,0,0.2)";
                upgradeLabel.textContent = "PRO –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ";
            } else {
                proPillEl.textContent = "Free";
            }
        } catch (e) {
            console.error(e);
        }
    }


    // ---------- SEARCH USERS ----------

    async function searchUser() {
        const query = document.getElementById("search").value.trim();
        const box = document.getElementById("search-results");

        if (!query) {
            box.innerHTML = "";
            return;
        }

        try {
            const res = await fetch(API_BASE + `/users/search?query=${encodeURIComponent(query)}`);
            const data = await res.json();

            const users = data.results || [];

            box.innerHTML = "";

            for (let u of users) {
                if (u.id === myID) continue;

                let proTag = u.is_pro
                    ? `<span class="user-tag-pro">PRO</span>`
                    : "";

                const el = document.createElement("div");
                el.className = "user-item";
                el.innerHTML = `
                    <div class="user-main">
                        <div class="user-name">${u.username}</div>
                        <div class="user-meta">ID: ${u.id}</div>
                    </div>
                    ${proTag}
                `;
                el.onclick = () => choosePeer(u.id, u.username);
                box.appendChild(el);
            }
        } catch (e) {
            console.error(e);
        }
    }


    // ---------- SELECT PEER ----------

    function choosePeer(id, username) {
        currentPeerID = id;
        currentPeerUsername = username;

        chatPeerEl.innerHTML = `–ß–∞—Ç –∑ <span>${username}</span>`;
        chatWindowEl.innerHTML = "";
        loadMessages();
        updateSecurityIndicator();
    }


    // ---------- SAVE SHARED SECRET ----------

    function saveDialogSecret() {
        if (!currentPeerID) return;
        const sec = document.getElementById("dialog-secret").value.trim();

        if (sec.length < 6) {
            showToast("–°–µ–∫—Ä–µ—Ç –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤", true);
            return;
        }

        const key = "spysignal_secret_" + dialogIdFor(currentPeerID);
        localStorage.setItem(key, sec);
        updateSecurityIndicator();
        showToast("–°–µ–∫—Ä–µ—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ");
    }


    // ---------- SEND MESSAGE ----------

    async function sendMessage() {
        if (!currentPeerID) {
            showToast("–û–±–µ—Ä–∏ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞", true);
            return;
        }
        const text = document.getElementById("msg-input").value.trim();
        if (!text) return;

        const dId = dialogIdFor(currentPeerID);

        const outgoingCount = dialogStates[dId]?.outgoing || 0;
        const payload = { kind: "text", body: text };

        try {
            const enc = await encryptPayload(currentPeerID, payload, outgoingCount);

            await fetch(API_BASE + "/messages", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    to: currentPeerID,
                    iv: enc.iv,
                    ciphertext: enc.ciphertext
                })
            });

            document.getElementById("msg-input").value = "";

            addMessageBubble({ from_id: myID, body: text, me: true });

            if (!dialogStates[dId]) dialogStates[dId] = { outgoing: 0, incoming: 0 };
            dialogStates[dId].outgoing++;

        } catch (e) {
            console.error(e);
            showToast("–ü–æ–º–∏–ª–∫–∞ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∞–±–æ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è", true);
        }
    }


    // ---------- DISPLAY MESSAGE ----------

    function addMessageBubble(msg) {
        const el = document.createElement("div");
        el.className = "msg" + (msg.me ? " me" : "");

        el.innerHTML = `
            ${msg.body}
            <div class="msg-meta">${msg.me ? "–Ø" : currentPeerUsername}</div>
        `;

        chatWindowEl.appendChild(el);
        chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
    }


    // ---------- LOAD MESSAGES ----------

    async function loadMessages() {
        if (!currentPeerID) return;

        const dId = dialogIdFor(currentPeerID);
        if (!dialogStates[dId])
            dialogStates[dId] = { outgoing: 0, incoming: 0 };

        try {
            const res = await fetch(API_BASE + `/messages?peer_id=${currentPeerID}`);
            const data = await res.json();
            const msgs = data.messages || [];

            chatWindowEl.innerHTML = "";

            for (let m of msgs) {
                const isMine = (m.from_id === myID);

                let decrypted = null;
                try {
                    decrypted = await decryptPayload(
                        currentPeerID,
                        m,
                        dialogStates[dId].outgoing,
                        dialogStates[dId].incoming
                    );
                } catch { }

                if (!decrypted) continue;

                if (isMine) dialogStates[dId].outgoing++;
                else dialogStates[dId].incoming++;

                if (decrypted.kind === "text") {
                    addMessageBubble({
                        from_id: m.from_id,
                        body: decrypted.body,
                        me: isMine
                    });
                }
            }

        } catch (e) {
            console.error(e);
        }
    }

    setInterval(loadMessages, 2000);


    // ---------- SELF-DESTRUCT ----------

    function toggleSelfDestruct() {
        selfDestructEnabled = !selfDestructEnabled;
        showToast(selfDestructEnabled ? "Self-destruct —É–≤—ñ–º–∫–Ω–µ–Ω–æ" : "Self-destruct –≤–∏–º–∫–Ω–µ–Ω–æ");
    }


    // ---------- PRO FEATURES ----------

    function needPro() {
        if (!isPro) {
            showToast("–î–æ—Å—Ç—É–ø–Ω–æ –ª–∏—à–µ —É PRO", true);
        }
    }

    async function fakeUpgrade() {
        if (isPro) {
            showToast("–£ —Ç–µ–±–µ –≤–∂–µ PRO");
            return;
        }
        const res = await fetch(API_BASE + "/billing/upgrade_fake", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: myID })
        });

        const data = await res.json();
        if (data.ok) {
            isPro = true;
            proUntil = data.pro_until;
            proPillEl.textContent = "PRO";
            upgradeLabel.textContent = "PRO –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ";
            showToast("PRO –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ!");
        }
    }


    // ---------- CALLS (WebRTC) ----------

    let peerConnection = null;

    async function startCall() {
        callStatusEl.textContent = "–í–∏–∫–ª–∏–∫‚Ä¶";

        peerConnection = new RTCPeerConnection();

        peerConnection.onicecandidate = (e) => {
            if (e.candidate) {
                fetch(API_BASE + "/call/candidate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        to: currentPeerID,
                        candidate: JSON.stringify(e.candidate)
                    })
                });
            }
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        await fetch(API_BASE + "/call/offer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                to: currentPeerID,
                sdp: JSON.stringify(offer)
            })
        });
    }

    function endCall() {
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
            callStatusEl.textContent = "–î–∑–≤—ñ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–æ";
        }
    }

    async function pollCall() {
        if (!currentPeerID) return;

        const res = await fetch(API_BASE + "/call/poll");
        const data = await res.json();
        const sigs = data.signals || [];

        for (let s of sigs) {
            if (s.from_id !== currentPeerID) continue;

            if (s.type === "offer") {
                callStatusEl.textContent = "–í—Ö—ñ–¥–Ω–∏–π –≤–∏–∫–ª–∏–∫‚Ä¶";

                peerConnection = new RTCPeerConnection();
                peerConnection.onicecandidate = (e) => {
                    if (e.candidate) {
                        fetch(API_BASE + "/call/candidate", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                to: currentPeerID,
                                candidate: JSON.stringify(e.candidate)
                            })
                        });
                    }
                };

                const offer = JSON.parse(s.data);
                await peerConnection.setRemoteDescription(offer);

                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                await fetch(API_BASE + "/call/answer", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        to: currentPeerID,
                        sdp: JSON.stringify(answer)
                    })
                });

                callStatusEl.textContent = "–ó'—î–¥–Ω–∞–Ω–æ";

            } else if (s.type === "answer" && peerConnection) {
                const ans = JSON.parse(s.data);
                await peerConnection.setRemoteDescription(ans);
                callStatusEl.textContent = "–ó'—î–¥–Ω–∞–Ω–æ";

            } else if (s.type === "candidate" && peerConnection) {
                const cand = JSON.parse(s.data);
                peerConnection.addIceCandidate(cand);
            }
        }
    }

    setInterval(pollCall, 2000);


    // ---------- LOGOUT ----------
    function logout() {
        myID = null;
        localStorage.clear();
        location.reload();
    }
</script>

</body>
</html>
